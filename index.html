<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å¬å–šè–ç´¢ï¼šæœªä¾†æˆ°å ´</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a1a; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; }
        .layout { display: flex; width: 95%; max-width: 1200px; gap: 20px; margin-top: 20px; }
        
        /* å€åŸŸæ¨£å¼ */
        .section { background: #2d2d2d; border-radius: 15px; padding: 20px; flex: 1; border: 1px solid #444; }
        h2 { border-bottom: 2px solid #555; padding-bottom: 10px; margin-top: 0; color: #00d4ff; }

        /* çµ±è¨ˆæ•¸æ“š */
        .stats-bar { width: 100%; background: #333; padding: 10px; display: flex; justify-content: center; gap: 30px; font-size: 1.2em; border-bottom: 3px solid #00d4ff; }
        .gold { color: #ffd700; font-weight: bold; }
        .dps { color: #ff4d4d; font-weight: bold; }

        /* å¡ç‰‡æ¨£å¼ */
        .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; height: 400px; overflow-y: auto; }
        .card-slot { padding: 10px; border-radius: 8px; text-align: center; font-size: 12px; transition: transform 0.2s; }
        .card-slot b { font-size: 14px; display: block; }
        .rank-0 { background: linear-gradient(135deg, #bbb, #eee); color: #222; }
        .rank-1 { background: linear-gradient(135deg, #2e7d32, #81c784); color: white; }
        .rank-2 { background: linear-gradient(135deg, #1565c0, #64b5f6); color: white; }
        .rank-3 { background: linear-gradient(135deg, #6a1b9a, #ba68c8); color: white; }
        .rank-4 { background: linear-gradient(135deg, #ef6c00, #ffb74d); color: white; border: 2px solid gold; }

        /* æˆ°å ´æ¨£å¼ */
        .monster-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 10px; }
        .goblin { background: #4e5d32; border: 1px solid #8bc34a; border-radius: 5px; padding: 5px; text-align: center; font-size: 12px; }
        .hp-bar { background: #222; height: 5px; width: 100%; margin-top: 5px; }
        .hp-fill { background: #ff4d4d; height: 100%; width: 100%; }

        .log { height: 100px; overflow-y: auto; background: #000; color: #0f0; padding: 10px; font-size: 12px; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="stats-bar">
    <span>ğŸ’° é‡‘å¹£: <span id="gold-count" class="gold">0</span></span>
    <span>âš”ï¸ ç¸½ç§’å‚· (DPS): <span id="total-dps" class="dps">0</span></span>
    <span>ğŸ† ç¸½æ“Šæ®º: <span id="total-kills">0</span></span>
</div>

<div class="layout">
    <div class="section">
        <h2>å¬å–šè–ç´¢</h2>
        <div class="inventory-grid" id="inventory-display"></div>
        <div class="log" id="game-log">æ­£åœ¨åˆå§‹åŒ–å¬å–šé™£...</div>
    </div>

    <div class="section">
        <h2>æœªä¾†æˆ°å ´</h2>
        <div id="monster-status">å“¥å¸ƒæ—ç­‰ç´š: Lv.<span id="goblin-lv">1</span></div>
        <div class="monster-grid" id="battle-field">
            </div>
    </div>
</div>

<script>
    // --- éŠæˆ²è¨­å®š ---
    const RARITIES = ["ç™½è‰²", "ç¶ è‰²", "è—è‰²", "ç´«è‰²", "æ©™è‰²"];
    const CHARACTERS = {
        "é›·ç´": { startRank: 0, chance: 0.50, baseAtk: 1, grow: 1 },
        "å‚‘æ": { startRank: 1, chance: 0.15, baseAtk: 20, grow: 2 },
        "ç‘èŒ²": { startRank: 2, chance: 0.05, baseAtk: 50, grow: 5 },
        "éœ“è™¹": { startRank: 3, chance: 0.01, baseAtk: 100, grow: 10 },
        "é›¢æ‰€": { startRank: 4, chance: 0.001, baseAtk: 500, grow: 50 }
    };

    // --- ç©å®¶è³‡æ–™ ---
    let gameState = JSON.parse(localStorage.getItem('sacredSorrowSave')) || {
        inventory: {},
        gold: 0,
        kills: 0
    };

    let monsters = []; // æˆ°å ´ä¸Šçš„å“¥å¸ƒæ—

    // --- é‚è¼¯å‡½æ•¸ ---

    function save() {
        localStorage.setItem('sacredSorrowSave', JSON.stringify(gameState));
    }

    function calculateCardAtk(name, rank, lv) {
        const config = CHARACTERS[name];
        // åŸºç¤æ”»æ“Š + ç­‰ç´šåŠ æˆ
        let atk = config.baseAtk + (lv - 1) * config.grow;
        // éšç´šç¿»å€é‚è¼¯ï¼šæ¯å‡ä¸€éšå‚·å®³ç¿»å€ (ç›¸å°æ–¼åˆå§‹éšç´š)
        let rankDiff = rank - config.startRank;
        if (rankDiff > 0) {
            atk = atk * Math.pow(2, rankDiff);
        }
        return atk;
    }

    function drawCard() {
        const roll = Math.random();
        let cumulativeChance = 0;
        for (let name in CHARACTERS) {
            cumulativeChance += CHARACTERS[name].chance;
            if (roll < cumulativeChance) {
                addCard(name, CHARACTERS[name].startRank, 1);
                return;
            }
        }
        log(`<span style="color:#666">å¬å–šå¤±æ•—...</span>`);
    }

    function addCard(name, rank, lv) {
        const key = `${name}-${rank}-${lv}`;
        gameState.inventory[key] = (gameState.inventory[key] || 0) + 1;
        checkUpgrade(name, rank, lv);
        updateUI();
        save();
    }

    function checkUpgrade(name, rank, lv) {
        const key = `${name}-${rank}-${lv}`;
        if (gameState.inventory[key] >= 10) {
            gameState.inventory[key] -= 10;
            let nextLv = lv + 1;
            let nextRank = rank;
            if (nextLv > 10) { nextLv = 1; nextRank += 1; }
            
            if (nextRank < RARITIES.length) {
                log(`<b style="color:yellow">åˆæˆæˆåŠŸï¼š${name} [${RARITIES[nextRank]} Lv.${nextLv}]</b>`);
                addCard(name, nextRank, nextLv);
            }
        }
    }

    // --- æˆ°é¬¥ç³»çµ± ---

    function spawnGoblin() {
        if (monsters.length < 10) {
            let lv = Math.floor(gameState.kills / 100);
            let multiplier = Math.pow(2, lv);
            monsters.push({
                maxHp: 10 * multiplier,
                hp: 10 * multiplier,
                gold: 1 * multiplier
            });
            updateBattleUI();
        }
    }

    function battleTick() {
        // è¨ˆç®—ç¸½ DPS
        let totalDps = 0;
        for (let key in gameState.inventory) {
            const count = gameState.inventory[key];
            if (count > 0) {
                const [name, rank, lv] = key.split('-');
                totalDps += calculateCardAtk(name, parseInt(rank), parseInt(lv)) * count;
            }
        }
        document.getElementById('total-dps').innerText = totalDps;

        // æ”»æ“Šç¬¬ä¸€éš»å“¥å¸ƒæ—
        if (monsters.length > 0 && totalDps > 0) {
            monsters[0].hp -= totalDps;
            if (monsters[0].hp <= 0) {
                let m = monsters.shift();
                gameState.gold += m.gold;
                gameState.kills += 1;
                log(`<span style="color:gold">æ“Šæ®ºå“¥å¸ƒæ—ï¼ç²å¾— ${m.gold} é‡‘å¹£</span>`);
            }
            updateBattleUI();
            updateUI();
            save();
        }
    }

    // --- UI æ›´æ–° ---

    function log(msg) {
        const logDiv = document.getElementById('game-log');
        logDiv.innerHTML = msg + "<br>" + logDiv.innerHTML;
        if(logDiv.childNodes.length > 20) logDiv.removeChild(logDiv.lastChild);
    }

    function updateUI() {
        document.getElementById('gold-count').innerText = gameState.gold;
        document.getElementById('total-kills').innerText = gameState.kills;
        document.getElementById('goblin-lv').innerText = Math.floor(gameState.kills / 100) + 1;

        const inv = document.getElementById('inventory-display');
        inv.innerHTML = "";
        for (let key in gameState.inventory) {
            const count = gameState.inventory[key];
            if (count > 0) {
                const [name, rank, lv] = key.split('-');
                const atk = calculateCardAtk(name, parseInt(rank), parseInt(lv));
                inv.innerHTML = `
                    <div class="card-slot rank-${rank}">
                        <b>${name}</b>
                        ${RARITIES[rank]} Lv.${lv}<br>
                        âš”ï¸ ${atk}<br>
                        (æŒæœ‰: ${count})
                    </div>
                ` + inv.innerHTML;
            }
        }
    }

    function updateBattleUI() {
        const field = document.getElementById('battle-field');
        field.innerHTML = "";
        monsters.forEach(m => {
            let percent = (m.hp / m.maxHp) * 100;
            field.innerHTML += `
                <div class="goblin">
                    ğŸ‘º å“¥å¸ƒæ—
                    <div class="hp-bar"><div class="hp-fill" style="width:${percent}%"></div></div>
                    <small>${Math.ceil(m.hp)} / ${m.maxHp}</small>
                </div>
            `;
        });
    }

    // --- å®šæ™‚å™¨ ---
    setInterval(drawCard, 1000);    // æ¯ç§’æŠ½å¡
    setInterval(spawnGoblin, 10000); // 10ç§’ç”Ÿå“¥å¸ƒæ—
    setInterval(battleTick, 1000);   // æ¯ç§’æˆ°é¬¥åˆ¤å®š

    updateUI();
</script>
</body>
</html>
