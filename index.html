const RARITIES = ["ç™½è‰²", "ç¶ è‰²", "è—è‰²", "ç´«è‰²", "æ©™è‰²"];
const CHARACTERS = {
    "é›·ç´": { startRank: 0, chance: 0.75 },    // 75% åˆå§‹ç™½å¡
    "å‚‘æ": { startRank: 1, chance: 0.15 },    // 15% åˆå§‹ç¶ å¡
    "ç‘èŒ²": { startRank: 2, chance: 0.05 },    // 5%  åˆå§‹è—å¡
    "éœ“è™¹": { startRank: 3, chance: 0.01 },    // 1%  åˆå§‹ç´«å¡
    "é›¢æ‰€": { startRank: 4, chance: 0.001 }   // 0.1% åˆå§‹æ©™å¡
};

// ç©å®¶èƒŒåŒ…ï¼škey ç‚º "è§’è‰²å-éšç´š-ç­‰ç´š"
let inventory = JSON.parse(localStorage.getItem('idleGameSave')) || {};

function saveGame() {
    localStorage.setItem('idleGameSave', JSON.stringify(inventory));
}

// æŠ½å¡é‚è¼¯
function drawCard() {
    const roll = Math.random(); // ç”¢ç”Ÿ 0~1 ä¹‹é–“çš„éš¨æ©Ÿæ•¸
    let cumulativeChance = 0;
    let found = false;

    for (let name in CHARACTERS) {
        cumulativeChance += CHARACTERS[name].chance;
        if (roll < cumulativeChance) {
            // æŠ½ä¸­è©²è§’è‰²
            addCard(name, CHARACTERS[name].startRank, 1);
            found = true;
            break;
        }
    }

    if (!found) {
        log(`<span style="color:#666">æŠ½å¡å¤±æ•—... (æ²’æŠ½ä¸­ä»»ä½•è§’è‰²)</span>`);
    }
}

function addCard(name, rank, lv) {
    const key = `${name}-${rank}-${lv}`;
    inventory[key] = (inventory[key] || 0) + 1;
    
    // æ ¹æ“šéšç´šé¡è‰²é¡¯ç¤ºæ—¥èªŒ
    const colorStyle = `class="rank-${rank}" style="padding:2px 5px; border-radius:3px"`;
    log(`ç²å¾—äº† <span ${colorStyle}>${name} [${RARITIES[rank]} Lv.${lv}]</span>`);
    
    checkUpgrade(name, rank, lv);
    updateUI();
    saveGame();
}

function checkUpgrade(name, rank, lv) {
    const key = `${name}-${rank}-${lv}`;
    if (inventory[key] >= 10) {
        inventory[key] -= 10;
        
        let nextLv = lv + 1;
        let nextRank = rank;

        if (nextLv > 10) {
            nextLv = 1;
            nextRank += 1;
        }

        if (nextRank < RARITIES.length) {
            log(`<b style="color:yellow">â˜… åˆæˆæˆåŠŸï¼${name} é€²åŒ–ç‚º [${RARITIES[nextRank]} Lv.${nextLv}]</b>`);
            addCard(name, nextRank, nextLv);
        } else {
            log(`<b style="color:gold">ğŸ‘‘ æ­å–œï¼${name} å·²é”åˆ°æœ€é«˜éšç´šï¼</b>`);
        }
    }
}

function log(msg) {
    const logDiv = document.getElementById('game-log');
    logDiv.innerHTML = msg + "<br>" + logDiv.innerHTML;
}

function updateUI() {
    const container = document.getElementById('inventory-display');
    const totalSpan = document.getElementById('total-count');
    container.innerHTML = "";
    let total = 0;

    // éæ­·æ‰€æœ‰èƒŒåŒ…ç‰©ä»¶
    for (let key in inventory) {
        const count = inventory[key];
        if (count > 0) {
            total += count;
            const [name, rank, lv] = key.split('-');
            container.innerHTML = `
                <div class="card-slot rank-${rank}">
                    <b>${name}</b><br>
                    ${RARITIES[rank]} Lv.${lv}<br>
                    æ•¸é‡: ${count}
                </div>
            ` + container.innerHTML;
        }
    }
    totalSpan.innerText = total;
}

// åˆå§‹åŒ–
updateUI();

// æ¯ 2 ç§’è‡ªå‹•æŠ½å¡ä¸€æ¬¡
setInterval(drawCard, 2000);
